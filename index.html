<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HG RP Site</title>
  <style>
    body {
      background: #0f0f0f;
      color: #eee;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
    }
    .hidden { display: none; }
    .box {
      border: 1px solid #444;
      padding: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>

<h1>Hunger Games RP</h1>

<!-- AUTH -->
<div id="auth" class="box">
  <h2>Login / Signup</h2>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <input id="username" placeholder="Username (signup only)"><br>

  <button onclick="signUp()">Sign Up</button>
  <button onclick="signIn()">Login</button>
  <p id="authMsg"></p>
</div>

<!-- PROFILE -->
<div id="profile" class="box hidden">
  <h2>Your Profile</h2>
  <p>Username: <span id="p_username"></span></p>
  <p>Age: <span id="p_age"></span></p>
  <p>Level: <span id="p_level"></span></p>
  <p>District: <span id="p_district"></span></p>
  <p>Role: <span id="p_role"></span></p>

  <button onclick="logout()">Logout</button>
</div>

<!-- ADMIN -->
<div id="admin" class="box hidden">
  <h2>Admin Panel</h2>
  <button onclick="adminLevelUp()">+1 Level</button>
  <button onclick="adminAgeUp()">+1 Age</button>
</div>

<!-- SUPABASE -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabaseUrl = 'https://nshyyzvtmhyeluvewczk.supabase.co';
  const supabaseKey = 'sb_publishable_d6_k7muWNpm7QgL1xeMdfg_emtXDi1b';
  const supabase = createClient(supabaseUrl, supabaseKey);

  let currentUserProfile = null;

  // ---------- AUTH ----------
  async function signUp() {
    const email = emailInput.value;
    const password = passwordInput.value;
    const username = usernameInput.value;

    const { data, error } = await supabase.auth.signUp({
      email, password
    });

    if (error) {
      authMsg.textContent = error.message;
      return;
    }

    await supabase.from("Users").insert({
      id: data.user.id,
      username,
      age: 11,
      level: 1,
      district: 1,
      role: "user"
    });

    authMsg.textContent = "Account created. Log in.";
  }

  async function signIn() {
    const { error } = await supabase.auth.signInWithPassword({
      email: emailInput.value,
      password: passwordInput.value
    });

    if (error) {
      authMsg.textContent = error.message;
      return;
    }

    loadProfile();
  }

  async function logout() {
    await supabase.auth.signOut();
    location.reload();
  }

  // ---------- PROFILE ----------
  async function loadProfile() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data } = await supabase
      .from("Users")
      .select("*")
      .eq("id", user.id)
      .single();

    currentUserProfile = data;

    auth.classList.add("hidden");
    profile.classList.remove("hidden");

    p_username.textContent = data.username;
    p_age.textContent = data.age;
    p_level.textContent = data.level;
    p_district.textContent = data.district;
    p_role.textContent = data.role;

    if (data.role === "admin") {
      admin.classList.remove("hidden");
    }
  }

  // ---------- ADMIN ----------
  async function adminLevelUp() {
    await supabase
      .from("Users")
      .update({ level: currentUserProfile.level + 1 })
      .eq("id", currentUserProfile.id);

    loadProfile();
  }

  async function adminAgeUp() {
    await supabase
      .from("Users")
      .update({ age: currentUserProfile.age + 1 })
      .eq("id", currentUserProfile.id);

    loadProfile();
  }

  // ---------- INIT ----------
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const usernameInput = document.getElementById("username");
  const authMsg = document.getElementById("authMsg");

  const auth = document.getElementById("auth");
  const profile = document.getElementById("profile");
  const admin = document.getElementById("admin");

  const p_username = document.getElementById("p_username");
  const p_age = document.getElementById("p_age");
  const p_level = document.getElementById("p_level");
  const p_district = document.getElementById("p_district");
  const p_role = document.getElementById("p_role");

  loadProfile();

  // expose to buttons
  window.signUp = signUp;
  window.signIn = signIn;
  window.logout = logout;
  window.adminLevelUp = adminLevelUp;
  window.adminAgeUp = adminAgeUp;
</script>

</body>
</html>
